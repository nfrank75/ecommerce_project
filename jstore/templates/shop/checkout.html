{% extends "base_checkout.html" %}

{% block content %}

<div  class="main_content">
    <div  class="section">
        <div  class="container">
            <div  class="row">
                <div  class="col-lg-6">
                    {% if not user.is_authenticated %}

                    <div  class="toggle_info"><span ><i
                        class="fas fa-user"></i>Returning customer? <a
                        href="#loginform" data-bs-toggle="collapse"
                       aria-expanded="false" class="collapsed">Click here to login</a></span></div>
                    <div  id="loginform" class="panel-collapse collapse login_form">
               <div  class="panel-body">
                   <p >If you have shopped with us before, please enter your
                       details below. If you are a new customer, please proceed to the Billing &amp;
                       Shipping section.</p>
                   <form  id="login_form" action="{% url 'shop:login_form' %}" method="post">
                       {% csrf_token %}
                       <div  class="form-group mb-3">
                           <input type="text" required="" name="email"
                               placeholder="Username Or Email" *
                               class="form-control">
                               <div class="text-danger email-error"></div> 
                           </div>
                       <div  class="form-group mb-3"><input
                                required="" type="password" name="password"
                               placeholder="Password" class="form-control"></div>
                               <div class="text-danger password-error"></div> 
                       <div  class="login_footer form-group mb-3">
                           <div  class="chek-form">
                               <div  class="custome-checkbox">
                                   <input type="checkbox" name="checkbox" id="remember"
                                       value="" class="form-check-input">
                                       <label for="remember" class="form-check-label">
                                           <span>Remember me</span>
                                       </label>
                               </div>
                           </div>
                       </div>
                       <div  class="form-group mb-3"><button
                                type="submit" name="login"
                               class="btn btn-fill-out btn-block">Log in</button></div>
                        </form>
                    </div>
                </div>
            </div>

                {% endif %}
                <div  class="col-lg-6">
                    <div  class="toggle_info"><span ><i
                                 class="fas fa-tag"></i>Have a coupon? <a
                                 href="#coupon" data-bs-toggle="collapse"
                                aria-expanded="false" class="collapsed">Click here to enter your code</a></span>
                    </div>
                    <div  id="coupon" class="panel-collapse collapse coupon_form">
                        <div  class="panel-body">
                            <p >If you have a coupon code, please apply it below.</p>
                            <div  class="coupon field_form input-group"><input
                                     type="text" value="" placeholder="Enter Coupon Code.."
                                    class="form-control">
                                <div  class="input-group-append"><button
                                         type="submit" class="btn btn-fill-out btn-sm">Apply
                                        Coupon</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div  class="row">
                <div  class="col-12">
                    <div  class="medium_divider"></div>
                    <div  class="divider center_icon"><i 
                            class="linearicons-credit-card"></i></div>
                    <div  class="medium_divider"></div>
                </div>
            </div>
            
            
            <div  class="row">
                <div  class="col-md-6">
                    <div  class="heading_s1">
                        <h4 >Billing Details</h4>
                    </div>

                    {% if user.is_authenticated %}
                        {% if user.addresses.all %}
                            <select name='address_billing_id' id='address_billing_id' class='form-control'>
                                <option value="">--- Choose a billing address ---</option>
                                {% for address in user.addresses.all %}
                                    <option value="{{ address.id }}" {% if address.id == address_billing_id %}selected{% endif %}>
                                        {{ address.name }} - {{ address.street }} {{ address.code_postal }} {{ address.city }} {{ address.country }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class='form-check form-switch'>
                                <input class='addNewAddress form-check-input' type='checkbox' id='add_new_adress'>
                                <label class="form-check-label" for="add_new_adress">Do You Want to Add A New Address?</label>
                            </div>
                            <div class='form-check form-switch'>
                                <input name="new_shipping_address" class='newShippingAddress form-check-input' type='checkbox' id='new_shipping_adress'
                                {% if new_shipping_address == 'true' %}checked{% endif %}>
                                <label class="form-check-label" for="new_shipping_adress">Do You Want to use another adddress for shipping ?</label>
                            </div>
                            
                            <div class="shipping_address_form {% if new_shipping_address != 'true' %}d-none{% endif %}">
                                <div class="heading_s1">
                                    <h4>Shipping Details</h4>
                                </div>
                                <select name='address_shipping_id' id='address_shipping_id' class='form-control'>
                                    <option value="">--- Choose a shipping address ---</option>
                                    {% for address in user.addresses.all %}
                                        <option value="{{ address.id }}" {% if address.id == address_shipping_id %}selected{% endif %}>
                                            {{ address.name }} - {{ address.street }} {{ address.code_postal }} {{ address.city }} {{ address.country }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <form class='d-none' id="addNewAddressForm" action="{% url 'shop:add_address' %}" method="post">
                                {% csrf_token %}
                                {{ address_form }}
                                <button type='submit' class="btn btn-success my-1">Save</button>
                            </form>
                        {% else %}
                            {% endif %}
                    {% else %}
                        <!-- circuit B !-->
                        <form action="{% url 'shop:add_address' %}" method="post">
                            {% csrf_token %}
                            {{ address_form }}
                            <button type='submit' class="btn btn-success my-1">Save</button>
                        </form>
                    {% endif %}
                        
                            

                    <div  class="heading_s1">
                        <h4 >Change Carrier</h4>
                        <select  class='form-control' name='carrier_id' id='carrier_id'>
                            {% for carrier in carriers %}
                                <option {% if cart.carrier_id == carrier.id %} selected {% endif %} value="{{carrier.id}}"> {{ carrier.name }} ({{ carrier.price }} FCFA ) </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div  class="col-md-6">
                    <div  class="order_review">
                        <div  class="heading_s1">
                            <h4 >Your Orders</h4>
                        </div>
                        <div  class="table-responsive order_table">
                            <table  class="table">
                                <thead >
                                    <tr >
                                        <th >Image</th>
                                        <th >Product</th>
                                        <th >Total</th>
                                    </tr>
                                </thead>
                                <tbody >
                                    {% for item in cart.items %}
                                        <tr >
                                            <td class="product-thumbnail">
                                                <a>
                                                    <img width="25" height="25" 
                                                    alt="product : {{item.product.name}}"
                                                    src="{{item.product.image}}">
                                                </a>
                                            </td>
                                            <td >{{item.product.name}}
                                                <span class="product-price"> {{item.product.solde_price}} FCFA</span>
                                                <span class="product-qty"> x {{item.quantity}}</span>
                                            </td>
                                            <td >{{ item.sub_total_ttc }}  FCFA</td>
                                        </tr>
                                    {% endfor %}

                                </tbody>
                                <tfoot >
                                    <tr >
                                        <th >SubTotal HT</th>
                                        <td></td>
                                        <td  class="product-subtotal">{{ cart.sub_total_ht }} FCFA </td>
                                    </tr>
                                    <tr >
                                        <th >Taxe</th>
                                        <td></td>
                                        <td  class="product-subtotal">{{ cart.taxe_amount }} FCFA </td>
                                    </tr>
                                    <tr >
                                        <th >Shipping ({{ cart.carrier_name }})</th>
                                        <td></td>
                                        <td >{{ cart.shipping_price }} FCFA</td>
                                    </tr>
                                    <tr >
                                        <th >Total</th>
                                        <td></td>
                                        <td  class="product-total">{{ cart.sub_total_with_shipping }} FCFA</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div  class="payment_method">
                            <div  class="heading_s1">
                                <h4 >Payment</h4>
                            </div>
                            <div  class="payment_option">
                                <div  class="custome-radio"><input 
                                        required="" type="radio" name="payment_option" checked=""
                                        class="form-check-input" id="directBankTransfer"
                                        value="directBankTransfer"><label 
                                        class="form-check-label" for="directBankTransfer">Direct Bank
                                        Transfer</label>
                                    <p  class="payment-text"> There are many variations of
                                        passages of Lorem Ipsum available, but the majority have suffered
                                        alteration. </p>
                                </div>
                                <div  class="custome-radio"><input 
                                        required="" type="radio" name="payment_option" checked=""
                                        class="form-check-input" id="checkPayment" value="checkPayment"><label
                                         class="form-check-label" for="checkPayment">Check
                                        Payment</label>
                                    <p  class="payment-text"> Please send your cheque to
                                        Store Name, Store Street, Store Town, Store State / County, Store Postcode.
                                    </p>
                                </div>
                                <div  class="custome-radio"><input 
                                        required="" type="radio" name="payment_option" checked=""
                                        class="form-check-input" id="paypal" value="paypal"><label
                                         class="form-check-label" for="paypal">Paypal</label>
                                    <p  class="payment-text"> Pay via PayPal; you can pay
                                        with your credit card if you don't have a PayPal account. </p>
                                </div>
                                <div  class="custome-radio"><input 
                                        required="" type="radio" name="payment_option" checked=""
                                        class="form-check-input" id="creditCard" value="creditCard"><label
                                         class="form-check-label" for="creditCard">Credit
                                        Card</label>
                                    <p  class="payment-text"> Please send your cheque to
                                        Store Name, Store Street, Store Town, Store State / County, Store Postcode.
                                    </p>
                                </div>

                            </div>
                            {% if ready_to_pay %}
                                <a  href="#" class="btn btn-fill-out btn-block">Pay now
                                    ({{ cart.sub_total_with_shipping }} FCFA)
                                </a>
                            {% endif %}
                        </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock content %}

{% block scripts %}
<script>
    // Sélection des éléments
    const loginForm = document.querySelector('form#login_form');
    const loginFormButton = document.querySelector('form#login_form button');
    const addShippingAddress = document.querySelector('input.newShippingAddress');
    const addAddressInput = document.querySelector('input.addNewAddress');
    const addNewAddressForm = document.querySelector('form#addNewAddressForm');
    const shippingAddressForm = document.querySelector('.shipping_address_form');
    const carrierForm = document.querySelector('select#carrier_id');
    const billingForm = document.querySelector('select#address_billing_id');
    const shippingForm = document.querySelector('select#address_shipping_id');

    // Mettez à jour les URLs de la page pour refléter les sélections de l'utilisateur
    const updateCheckoutPage = () => {
        const queryParams = new URLSearchParams(window.location.search);

        const billingId = billingForm ? billingForm.value : '';
        const shippingId = shippingForm ? shippingForm.value : '';
        const carrierId = carrierForm ? carrierForm.value : '';
        const newShippingAddressChecked = addShippingAddress ? addShippingAddress.checked : false;

        queryParams.set('carrier_id', carrierId);
        queryParams.set('address_billing_id', billingId);
        queryParams.set('new_shipping_address', newShippingAddressChecked);

        if (newShippingAddressChecked) {
            queryParams.set('address_shipping_id', shippingId);
        } else {
            // Si l'adresse de livraison est la même, on s'assure que le paramètre n'est pas présent
            queryParams.delete('address_shipping_id');
        }

        // Rediriger la page avec les nouveaux paramètres
        window.location.href = window.location.pathname + '?' + queryParams.toString();
    };

    // Écouteur d'événement pour le changement de transporteur
    if (carrierForm) {
        carrierForm.addEventListener('change', updateCheckoutPage);
    }

    // Écouteur d'événement pour le changement d'adresse de facturation
    if (billingForm) {
        billingForm.addEventListener('change', updateCheckoutPage);
    }

    // Écouteur d'événement pour le changement d'adresse de livraison
    if (shippingForm) {
        shippingForm.addEventListener('change', updateCheckoutPage);
    }

    // Fonction pour afficher/masquer le formulaire d'ajout d'une nouvelle adresse de facturation
    const displayNewAddressForm = (event) => {
        const checked = event.target.checked;
        if (addNewAddressForm) {
            if (checked) {
                addNewAddressForm.classList.remove('d-none');
                if (billingForm) {
                    billingForm.classList.add('d-none');
                }
            } else {
                addNewAddressForm.classList.add('d-none');
                if (billingForm) {
                    billingForm.classList.remove('d-none');
                }
            }
        }
    };

    // Ajout de l'écouteur d'événement pour le checkbox "Add A New Address?"
    if (addAddressInput) {
        addAddressInput.addEventListener('change', displayNewAddressForm);
    }

    // Fonction pour afficher/masquer le formulaire d'adresse de livraison différente
    const displayShippingAddressForm = () => {
        const checked = addShippingAddress.checked;
        if (shippingAddressForm) {
            if (checked) {
                shippingAddressForm.classList.remove('d-none');
                if (shippingForm) {
                    shippingForm.classList.remove('d-none');
                }
            } else {
                shippingAddressForm.classList.add('d-none');
                if (shippingForm) {
                    shippingForm.classList.add('d-none');
                }
            }
        }
    };

    // Ajout de l'écouteur d'événement pour le checkbox "Do You Want to use another adddress for shipping ?"
    if (addShippingAddress) {
        addShippingAddress.addEventListener('change', updateCheckoutPage);
    }
    
    //------------------- Partie pour le login AJAX ----------------------
    const handleSubmit = (event) => {
        event.preventDefault();

        const emailError = loginForm.querySelector('.email-error');
        const passwordError = loginForm.querySelector('.password-error');
        const formError = loginForm.querySelector('.form-error'); // Assurez-vous d'avoir cet élément dans votre HTML

        const email = loginForm.elements['email'].value;
        const password = loginForm.elements['password'].value;
        const token = loginForm.elements['csrfmiddlewaretoken'].value;

        if (email.trim() === '') {
            emailError.innerText = 'Please fill out the email field';
            return;
        } else {
            emailError.innerText = '';
        }

        if (password.trim() === '') {
            passwordError.innerText = 'Please fill out the password field';
            return;
        } else {
            passwordError.innerText = '';
        }

        const formData = new FormData();
        formData.append('email', email);
        formData.append('password', password);
        formData.append('csrfmiddlewaretoken', token);

        fetch("{% url 'shop:login_form' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (!data.isSuccess) {
                if (formError) {
                    formError.innerText = data.message;
                }
            } else {
                if (formError) {
                    formError.innerText = '';
                }
                window.location.href = window.location.href;
            }
        })
        .catch(error => {
            console.error('Erreur lors de la requête AJAX:', error);
            if (formError) {
                formError.innerText = 'An error occurred. Please try again.';
            }
        });
    };

    if (loginFormButton) {
        loginFormButton.addEventListener('click', handleSubmit);
    }

    // Exécutez la fonction une fois au chargement de la page pour gérer l'affichage initial
    displayShippingAddressForm();

</script>
{% endblock %}


